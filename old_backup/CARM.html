<!DOCTYPE html>
<head>

  <title>Title</title>
  <meta name="description" content="description" />
  <meta name="keywords" content="keywords" />
  <meta http-equiv="content-type" content="text/html; charset=utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="shortcut icon" type="image/png" href="favicon.png" />
  <meta http-equiv="X-UA-Compatible" content="IE=9" />
  <link rel="stylesheet" type="text/css" href="css/style.css" />
</head>


<body>

  <div id="main">
    <div class="container">
      <nav class="fixed-nav-bar">

        <button type="button" class="navbar-toggle" data-toggle="collapse" data-target="#myNavbar">
        </button>
        <div class="collapse navbar-collapse" id="myNavbar">
          <ul class="nav navbar-nav" id="menu">
            <li><a href="index.html">Home</a>
            </li>
            <li><a href="Gallery.html">Image Gallery</a>
            </li>
            <li><a href="Contact.html" class="separator">Contact</a>
            </li>
            <li><a href="Java.html">Java</a>
            </li>
            <li class="current"><a href="CARM.html">C (ARM)</a>
            </li>
            <li><a href="Web.html">Html/css/js</a>
            </li>
            <li><a href="Testjs.html">Testjs</a>
            </li>
          </ul>
		  <ul class="nav navbar-nav navbar-right" id="menu">
        <li><a href="#" onClick="alert('Sorry, not yet implemented. But im working on it!')">Login</a></li>
      </ul>
        </div>

      </nav>
            <div id="slider">
                <div class="slider">
                    <div id="banner-fade">
                        <ul class="bjqs">
                            <li>
                                <img src="images/leaf1.jpg" title="Agile">
                            </li>
                            <li>
                                <img src="images/leaf2.jpg" title="Flexible">
                            </li>
                            <li>
                                <img src="images/leaf3.jpg" title="Customizable">
                            </li>
                            <li>
                                <img src="images/leaf4.jpg" title="Fast">
                            </li>
                        </ul>
                    </div>
                </div>
            </div>

           <div id="site_content">
        <div class="sidebar_container">
          <div class="sidebar">
            <div class="sidebar_item" id="right">
              <h1>Page Sections</h1>
              <ul>
                <br> <font size="3px">
							<li><div id="codeSource"style="color: #000000; cursor: pointer; cursor: hand;"> Source code  </div></li>
							<br>
							<ul>
								<li><div id="upMain" style="color: #000000; cursor: pointer; cursor: hand;">Main</div>
								</li>
								<li><div id="upButtons"  style="color: #000000; cursor: pointer; cursor: hand;">Buttons</div>
								</li>
								<li><div id="upLCD"  style="color: #000000; cursor: pointer; cursor: hand;">LCD Display</div>
								</li>
								<li><div id="upRTC"  style="color: #000000; cursor: pointer; cursor: hand;">Real time clock</div>
								</li>
								<li><div id="upTimer"  style="color: #000000; cursor: pointer; cursor: hand;">Timer</div>
								</li>
							</ul>
							<br>
							<li><div id="upBoard" style="color: #000000; cursor: pointer; cursor: hand;">Board</div></li>
							 </font>
               
              </ul>
            </div>
            <!--close sidebar_item-->
          </div>
          <!--close sidebar-->
        </div>
        <br>
        <br>
        <h3>Real time clock </h3>
        <div class="rightsideBar">
          <p>

		  <h4> This project is a Real time clock on a FRDM-KL46Z Board using Keil studio. It has Cortex M-0 processor, some I/O ports, Leds, LCD display, Quartz, some accelerometers, photoresistor and more. Wider board specification is under section "Board". As for the project, it was inspired by one of university courses for this board. Why not use a ready LCD display to play with it a little ?
		  <br> We get this idea with a friend of mine, who was interested in the board functionality as well. So having programmed LCD display of this board we jumped into this real time clock using build in quartz. While the program on the board starts, we are asked to set the current hour and minute using 2 buttons. Now there was a question when to start "counting" time. Either use a separate button to initialize this process or start whole thing on any button click. 
		  <br> In this case we agreed to use the second option as it seemed to us to be closely related how real clocks work. Nevertheless, once we set the time, it is done, meaning the board with this program will not measure time displaying correct time.
		  <br><br> Below I will present some of the code we wrote. released under GNU license. There are of course some header files, that will not be attached because they only contain including other files and libraries. 
		  <br>
		  
		  
 <div id="uMain"></div><br>
		  <br>Main file contains of only initializing the whole thing and the infinite while loop to have the programm working
		  <br><div class="code">
		  <xmp style="margin-left:15px; margin-right:15px; font-size: 12px; letter-spacing: -1px">
uint8_t minutes;
uint8_t seconds;
uint8_t start_counting;
			
int main(void) {
	
    lcd_init();
    buttons_init();
    tpm_init();
		rtc_init();
		SystemCoreClockUpdate();
    time_reset(&minutes,&seconds);
	
	   while (1);
    };

</xmp></div>

<br><div id="uButtons"></div><br> Here is the buttons functionality. Button are placed as two pins [SW1_PIN] and [SW3_PIN]<br>
		  <br><div class="code">
		  <xmp style="margin-left:15px; margin-right:15px; font-size: 12px; letter-spacing: -1px">
void buttons_init()
{
    /* Enable port clocks */
    SIM->SCGC5 |=  SIM_SCGC5_PORTC_MASK;
		SIM->SCGC5 |=  SIM_SCGC5_PORTE_MASK;

    /* Configure pin as GPIO */
    PORTC->PCR[SW1_PIN] |= PORT_PCR_MUX(1);
    PORTC->PCR[SW3_PIN] |= PORT_PCR_MUX(1);
    /* Enable internal pullup resistor */
    PORTC->PCR[SW1_PIN] |= PORT_PCR_PE_MASK | PORT_PCR_PS_MASK;
    PORTC->PCR[SW3_PIN] |= PORT_PCR_PE_MASK | PORT_PCR_PS_MASK;
	
    /* Interrupt on falling edge */
    PORTC->PCR[SW1_PIN] |= PORT_PCR_IRQC(0x0A);
    PORTC->PCR[SW3_PIN] |= PORT_PCR_IRQC(0x0A);

    /* Enable IRQ */
    NVIC_ClearPendingIRQ(PORTC_PORTD_IRQn);
    NVIC_EnableIRQ(PORTC_PORTD_IRQn);
    NVIC_SetPriority(PORTC_PORTD_IRQn, 1);
}

void PORTC_PORTD_IRQHandler()
{
    /* Interrupt on SW1 detected */
    if (PORTC->PCR[SW1_PIN] & PORT_PCR_ISF_MASK) {
			
			  time_counting(&minutes, &seconds, 1);
        lcd_displaytime(minutes, seconds);
        /* Clear */
        PORTC->PCR[SW1_PIN] |= PORT_PCR_ISF_MASK;
    }
		/* Interrupt on SW3 detected */
	  if (PORTC->PCR[SW3_PIN] & PORT_PCR_ISF_MASK) {
			  time_counting(&minutes,&seconds, 60);
        lcd_displaytime(minutes,seconds);
        /* Clear */
        PORTC->PCR[SW3_PIN] |= PORT_PCR_ISF_MASK;
    }
	}

</xmp></div>
 <div id="uLCD"></div><br>
		  <br>LCD Display file was created with a lot help from the university files, as it is a little complex. Here the code is cut a little to maintain the readibility. <br><div class="code">
		  <xmp style="margin-left:15px; margin-right:15px; font-size: 12px; letter-spacing: -1px">
const static uint8_t LCD_Frontplane_Pin[LCD_NUM_FRONTPLANE_PINS] = {
    LCD_FRONTPLANE0, LCD_FRONTPLANE1, LCD_FRONTPLANE2, LCD_FRONTPLANE3,
    LCD_FRONTPLANE4, LCD_FRONTPLANE5, LCD_FRONTPLANE6, LCD_FRONTPLANE7
};

void lcd_init(void)
{
    SIM->SCGC5 |= SIM_SCGC5_PORTB_MASK |
        SIM_SCGC5_PORTC_MASK |
        SIM_SCGC5_PORTD_MASK |
        SIM_SCGC5_PORTE_MASK |
        SIM_SCGC5_SLCD_MASK;

    LCD->GCR |= LCD_GCR_PADSAFE_MASK;
    LCD->GCR &= ~LCD_GCR_LCDEN_MASK;

    PORTB->PCR[7] = PORT_PCR_MUX(0);
	.
	.
	.
	.
    PORTE->PCR[5] = PORT_PCR_MUX(0);

    LCD->GCR = LCD_GCR_RVTRIM(0x00) |
        LCD_GCR_CPSEL_MASK |
        LCD_GCR_LADJ(0x03) |
        LCD_GCR_VSUPPLY_MASK |
        LCD_GCR_ALTDIV(0x00) |
        LCD_GCR_SOURCE_MASK |
        LCD_GCR_LCLK(0x01) |
        LCD_GCR_DUTY(0x03);

    LCD->AR = LCD_AR_BRATE(0x00);
    LCD->FDCR = 0x00000000;

    LCD->PEN[0] = LCD_PEN_PEN(1u<<7u) |
        LCD_PEN_PEN(1u<<8u) |
        LCD_PEN_PEN(1u<<10u) |
        LCD_PEN_PEN(1u<<11u) |
        LCD_PEN_PEN(1u<<17u) |
        LCD_PEN_PEN(1u<<18u) |
        LCD_PEN_PEN(1u<<19u);

    LCD->PEN[1] = LCD_PEN_PEN(1u<<5u) |
        LCD_PEN_PEN(1u<<6u) |
        LCD_PEN_PEN(1u<<8u) |
        LCD_PEN_PEN(1u<<20u) |
        LCD_PEN_PEN(1u<<21u);
    LCD->BPEN[0] = LCD_BPEN_BPEN(1u<<18u) |
        LCD_BPEN_BPEN(1u<<19u);
    LCD->BPEN[1] = LCD_BPEN_BPEN(1u<<8u) |
        LCD_BPEN_BPEN(1u<<20u);
    LCD->WF[0] = LCD_WF_WF0(0x00) |
        LCD_WF_WF1(0x00) |
        LCD_WF_WF2(0x00) |
        LCD_WF_WF3(0x00);
    .
	.
	.
	.
	
    LCD->WF[15] = LCD_WF_WF60(0x00) |
        LCD_WF_WF61(0x00) |
        LCD_WF_WF62(0x00) |
        LCD_WF_WF63(0x00);

    LCD->GCR &= ~LCD_GCR_PADSAFE_MASK;
    LCD->GCR |= LCD_GCR_LCDEN_MASK;
}

void SegLCD_Set(uint8_t Value,uint8_t Digit)
{
    if (Digit > 4) {
        SegLCD_DisplayError(0x01);
    }
    else {
        switch (Value) {
        case 0x00:
            LCD->WF8B[LCD_Frontplane_Pin[((2*Digit)-2)]] =
                (LCD_SEG_D | LCD_SEG_E |LCD_SEG_F);
            LCD->WF8B[LCD_Frontplane_Pin[((2*Digit)-1)]] =
                (LCD_SEG_A | LCD_SEG_B | LCD_SEG_C);
            break;
       .
	   .
	   .
	   .
        case 0x0F:
            LCD->WF8B[LCD_Frontplane_Pin[((2*Digit)-2)]] =
                (LCD_SEG_E | LCD_SEG_F | LCD_SEG_G);
            LCD->WF8B[LCD_Frontplane_Pin[((2*Digit)-1)]] =
                LCD_SEG_A;
            break;
        }
    }
}

void lcd_displaytime(uint8_t Value1, uint8_t Value2)
{
    if ((Value1 > 99) | (Value2 > 99)) {
        SegLCD_DisplayError(0x10);
    }
    else {
        SegLCD_Set(Value1/10, 1);
        SegLCD_Set(Value1 % 10, 2);
        SegLCD_Set(Value2/10, 3);
        SegLCD_Set(Value2 % 10, 4);
        SegLCD_Col_On();
    }
}

void SegLCD_DisplayError(uint8_t ErrorNum)
{
    LCD->WF8B[LCD_FRONTPLANE0] = (LCD_SEG_D | LCD_SEG_E | LCD_SEG_F | LCD_SEG_G);
    LCD->WF8B[LCD_FRONTPLANE1] = (LCD_SEG_A);
    LCD->WF8B[LCD_FRONTPLANE2] = (LCD_SEG_E | LCD_SEG_G);
    LCD->WF8B[LCD_FRONTPLANE3] = (LCD_CLEAR);
    LCD->WF8B[LCD_FRONTPLANE4] = (LCD_SEG_E | LCD_SEG_G);
    LCD->WF8B[LCD_FRONTPLANE5] = (LCD_CLEAR);
    if (ErrorNum < 0x10) {
        SegLCD_Set(ErrorNum,4);
    }
    else {
        LCD->WF8B[LCD_FRONTPLANE6] = (LCD_CLEAR);
        LCD->WF8B[LCD_FRONTPLANE7] = (LCD_CLEAR);
    }
}
</xmp></div>
 <div id="uRTC"></div><br>
		  <br>Now, real time clock is the thing here. We even added the flashing dots to visualise the real clock <br><div class="code">
		  <xmp style="margin-left:15px; margin-right:15px; font-size: 12px; letter-spacing: -1px">
int rtc_count = 0;

void rtc_init()
{
    /* Clock for rtc */
    SIM->SCGC6 |= SIM_SCGC6_RTC_MASK;

    /* Ensure PTC1 is configured as RTC input clock */
    PORTC->PCR[1] &= ~PORT_PCR_MUX_MASK;
    PORTC->PCR[1] = PORT_PCR_MUX(1);

    /* Clear the OSC32KSEL field to select osc */
    SIM->SOPT1 &= ~SIM_SOPT1_OSC32KSEL_MASK;
	
    /* RTC_CLKIN selected as the ERCLK32K */
    SIM->SOPT1 |= SIM_SOPT1_OSC32KSEL(2);

    /* Set the oscillator enable bit */
    OSC0->CR |= OSC_CR_ERCLKEN_MASK;
	
    /* Clear any pending itnerupts */
    NVIC_ClearPendingIRQ(RTC_Seconds_IRQn);
    NVIC_EnableIRQ(RTC_Seconds_IRQn);
    NVIC_SetPriority(RTC_Seconds_IRQn, 2);

    /* Time seconds interrupt enable */
    RTC->IER |= RTC_IER_TSIE_MASK;
		
    RTC->TSR =  0;							// time counter enable
    RTC->SR |= RTC_SR_TCE_MASK;
}

void RTC_Seconds_IRQHandler()
{
				if(++rtc_count == 59){
					time_counting(&minutes,&seconds ,1);
					lcd_displaytime(minutes,seconds);
					rtc_count = 0;
} 
				if(rtc_count%2==0)						// flashing of dots between hours and minutes
				{   				
				SegLCD_Col_On();
				} 
				else			
					SegLCD_Col_Off();
}

</xmp></div>
 <div id="uTimer"></div><br>
		  <br>Timer is designed to be the most global it could be, so that in case of any changes it is still reliable<br><div class="code">
		  <xmp style="margin-left:15px; margin-right:15px; font-size: 12px; letter-spacing: -1px">
void time_counting(uint8_t *min, uint8_t *sec, uint8_t val)
{
		
    uint8_t m_i = (*sec+val)/60;
		*min = (*min+m_i)%24;
    *sec = (*sec+val)%60;
}


void time_reset(uint8_t *seconds, uint8_t *minutes)
{
    *minutes = 0;
    *seconds = 0;
}


</xmp></div>
<div id="uBoard"></div><br>
		  <br>Board:<br>
MKL46Z256VLL4MCU – 48 MHz<br>256 KB flash, <br>32 KB SRAM, <br>segment LCD, USB OTG (FS) <br>
Capacitive touch slider,<br> MMA8451Q accelerometer,<br> MAG3110 magnetometer
<br>Flexible power supply options – USB<br>
OpenSDA debug interface
<br>Mass storage device flash programming interface (default)
<br>
<br>		  You can read more here:
		  <a href="http://www.nxp.com/products/software-and-tools/hardware-development-tools/freedom-development-boards/freedom-development-platform-for-kinetis-kl3x-and-kl4x-mcus:FRDM-KL46Z?" style="color: #000000">LINK</a>
            <br>
			<div class="carm">
<img src="images/Board.jpg" title="FRDM-KL46Z">
</div>
        </div>
      </div>

            <div id="footer">Questions ? Suggestions ? Contact me at: michal.czerwien@gmail.com &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp Copyright &copy; Michal 2015 All rights reserved.</div>
          </div>
     <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
  <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js"></script>
  <script src="js/bjqs-1.3.min.js"></script>
  <script src="js/script.js"></script>
  <script src="js/jquery.js"></script>

</body>

</html>
